// ============================================
// Insurance Image Collection System - UPDATED VERSION
// VERSION: 2.3 - Enhanced Debugging & Error Handling
// AUTHOR: Bill Layne Insurance Agency
// UPDATED: December 2024
// ============================================

// Configuration - YOUR ACTUAL VALUES
const CONFIG = {
  SPREADSHEET_ID: '180bwnBev519DHv2RRtUFXtiCEmrCBv8nkAreAXamZUo',
  DRIVE_FOLDER_ID: '1un6kI4LYdGMZ0ACJ4vWhej9GC85XvyEU',
  EMAIL_TO: 'Docs@BillLayneInsurance.com',
  EMAIL_CC: 'Save@BillLayneInsurance.com',
  AGENCY_NAME: 'Bill Layne Insurance Agency',
  AGENCY_PHONE: '336-835-1993',
  AGENCY_ADDRESS: '1283 N Bridge St, Elkin NC 28621',
  AGENCY_WEBSITE: 'www.BillLayneInsurance.com',
  AGENCY_EMAIL: 'Save@BillLayneInsurance.com',
  LOGO_URL: 'https://i.imgur.com/uVVShPM.png',
  MAX_FILE_SIZE: 20 * 1024 * 1024, // 20MB
  ALLOWED_MIME_TYPES: [
    'image/jpeg',
    'image/png',
    'image/webp',
    'application/pdf'
  ]
};

// Main function to handle form submissions
function doPost(e) {
  try {
    Logger.log('=== NEW SUBMISSION RECEIVED ===');
    Logger.log('Raw request received');
    
    // Parse the incoming data
    let data;
    try {
      data = JSON.parse(e.postData.contents);
    } catch (parseError) {
      Logger.log('Error parsing JSON: ' + parseError.toString());
      return createErrorResponse('Invalid data format');
    }
    
    Logger.log('Customer: ' + (data.customerName || 'NOT PROVIDED'));
    Logger.log('Email: ' + (data.email || 'NOT PROVIDED'));
    Logger.log('Photo category: ' + (data.photoCategory || 'NOT PROVIDED'));
    Logger.log('Number of images: ' + (data.images ? data.images.length : 0));
    
    // Validate submission
    const validation = validateSubmission(data);
    if (!validation.valid) {
      Logger.log('Validation failed: ' + validation.error);
      return createErrorResponse(validation.error);
    }
    
    // Generate or use reference number
    const referenceNumber = data.referenceNumber || generateReferenceNumber();
    Logger.log('Reference number: ' + referenceNumber);
    
    // Create folder in Google Drive
    const folderInfo = createDriveFolder(data, referenceNumber);
    Logger.log('Folder created: ' + folderInfo.url);
    
    // Process and save images
    const processResult = processImages(data.images, folderInfo.id, referenceNumber, data);
    Logger.log('Images processed: ' + processResult.savedCount + ' of ' + processResult.totalCount);
    
    // Save to spreadsheet
    saveToSheet(data, referenceNumber, folderInfo.url, processResult);
    Logger.log('Saved to sheet');
    
    // Send notifications
    sendNotifications(data, referenceNumber, folderInfo.url, processResult);
    Logger.log('Notifications sent');
    
    Logger.log('=== SUBMISSION COMPLETED SUCCESSFULLY ===');
    
    // Return success response
    return ContentService
      .createTextOutput(JSON.stringify({
        status: 'success',
        message: 'Images uploaded successfully',
        referenceNumber: referenceNumber,
        imageCount: processResult.savedCount,
        totalSize: processResult.totalSize,
        compressionSaved: processResult.compressionSaved
      }))
      .setMimeType(ContentService.MimeType.JSON)
      .setHeaders({
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'POST',
        'Access-Control-Allow-Headers': 'Content-Type'
      });
      
  } catch (error) {
    Logger.log('=== ERROR IN DOPOST ===');
    Logger.log('Error: ' + error.toString());
    Logger.log('Stack: ' + error.stack);
    logError(error, e);
    
    return createErrorResponse('Upload failed: ' + error.message);
  }
}

// Handle OPTIONS requests (CORS preflight)
function doOptions() {
  return ContentService
    .createTextOutput('')
    .setMimeType(ContentService.MimeType.TEXT)
    .setHeaders({
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type',
      'Access-Control-Max-Age': '86400'
    });
}

// Validate submission
function validateSubmission(data) {
  const errors = [];
  
  // Customer name is required
  if (!data.customerName || data.customerName.trim() === '') {
    errors.push('Customer name is required');
  }
  
  // Email is required
  if (!data.email || data.email.trim() === '') {
    errors.push('Email address is required');
  }
  
  // Validate email format
  if (data.email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(data.email)) {
      errors.push('Invalid email format');
    }
  }
  
  // Photo category - make it optional since it might come from URL params
  if (!data.photoCategory || data.photoCategory.trim() === '') {
    Logger.log('Warning: No photo category provided, will use "other"');
    data.photoCategory = 'other';
  }
  
  // Check images
  if (!data.images || data.images.length === 0) {
    errors.push('At least one image is required');
  }
  
  // Validate each image
  if (data.images && data.images.length > 0) {
    data.images.forEach(function(img, index) {
      if (!img || !img.data) {
        errors.push('Image ' + (index + 1) + ': No data provided');
      }
      
      // Check for suspicious file extensions
      if (img.name) {
        const suspiciousPatterns = /\.(exe|scr|bat|cmd|com|pif|msi|jar|app|vbs|js|ws)/i;
        if (suspiciousPatterns.test(img.name)) {
          errors.push('File ' + (index + 1) + ': Suspicious file extension detected');
        }
      }
    });
  }
  
  if (errors.length > 0) {
    return { valid: false, error: errors.join('; ') };
  }
  
  return { valid: true };
}

// Create folder in Google Drive
function createDriveFolder(data, referenceNumber) {
  const mainFolder = DriveApp.getFolderById(CONFIG.DRIVE_FOLDER_ID);
  
  // Create date-based structure
  const date = new Date();
  const year = date.getFullYear().toString();
  const month = (date.getMonth() + 1).toString().padStart(2, '0');
  
  // Get or create year folder
  let yearFolder;
  const yearFolders = mainFolder.getFoldersByName(year);
  if (yearFolders.hasNext()) {
    yearFolder = yearFolders.next();
  } else {
    yearFolder = mainFolder.createFolder(year);
  }
  
  // Get or create month folder
  let monthFolder;
  const monthName = month + '-' + getMonthName(date.getMonth());
  const monthFolders = yearFolder.getFoldersByName(monthName);
  if (monthFolders.hasNext()) {
    monthFolder = monthFolders.next();
  } else {
    monthFolder = yearFolder.createFolder(monthName);
  }
  
  // Create customer folder
  const safeName = data.customerName.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 50);
  const categoryLabel = data.photoCategory ? ('_' + data.photoCategory.toUpperCase()) : '';
  const folderName = referenceNumber + categoryLabel + '_' + safeName;
  const customerFolder = monthFolder.createFolder(folderName);
  
  // Create category-based subfolders
  const categoryFolders = {
    'home': ['Exterior_Photos', 'Interior_Photos', 'Utility_Photos'],
    'claims': ['Damage_Photos', 'Context_Photos'],
    'documents': ['Identification', 'Insurance_Docs', 'Property_Docs'],
    'other': ['Photos']
  };
  
  const foldersToCreate = categoryFolders[data.photoCategory] || categoryFolders['other'];
  foldersToCreate.forEach(function(folderName) {
    try {
      customerFolder.createFolder(folderName);
    } catch (e) {
      Logger.log('Could not create subfolder ' + folderName + ': ' + e.toString());
    }
  });
  
  // Create info file
  const infoContent = 'Submission Information\n' +
    '=======================\n' +
    'Reference Number: ' + referenceNumber + '\n' +
    'Submission Date: ' + date.toLocaleString('en-US', {timeZone: 'America/New_York'}) + ' EST\n' +
    'Processing Status: New\n\n' +
    'Customer Information\n' +
    '====================\n' +
    'Name: ' + data.customerName + '\n' +
    'Email: ' + (data.email || 'Not provided') + '\n' +
    'Phone: ' + (data.phone || 'Not provided') + '\n' +
    'Address: ' + (data.address || 'Not provided') + '\n' +
    'City: ' + (data.city || 'Not provided') + '\n' +
    'State: ' + (data.state || 'NC') + '\n' +
    'ZIP: ' + (data.zip || 'Not provided') + '\n\n' +
    'Submission Details\n' +
    '==================\n' +
    'Photo Category: ' + (data.photoCategory || 'Not specified') + '\n' +
    'Type: ' + (data.type || 'Not specified') + '\n' +
    'Purpose: ' + (data.purpose || 'Not specified') + '\n' +
    'Current Carrier: ' + (data.currentCarrier || 'Not provided') + '\n' +
    (data.vehicleInfo ? 'Vehicle Info: ' + data.vehicleInfo + '\n' : '') + '\n' +
    'Files Information\n' +
    '=================\n' +
    'Total Files: ' + (data.images ? data.images.length : 0) + '\n' +
    'Upload Method: Web Form v2.3\n\n' +
    'Notes\n' +
    '=====\n' +
    (data.notes || 'No additional notes provided') + '\n\n' +
    '---\n' +
    'Processed by: Image Collection System v2.3\n' +
    'Agency: ' + CONFIG.AGENCY_NAME;
  
  customerFolder.createFile('submission_info.txt', infoContent);
  
  return {
    id: customerFolder.getId(),
    url: customerFolder.getUrl(),
    folder: customerFolder
  };
}

// Process and save images
function processImages(images, folderId, referenceNumber, data) {
  Logger.log('Processing images...');
  
  if (!images || images.length === 0) {
    return {
      savedCount: 0,
      totalCount: 0,
      errors: [],
      totalSize: 0,
      compressionSaved: 0
    };
  }
  
  let savedCount = 0;
  let totalSize = 0;
  let originalSize = 0;
  const errors = [];
  
  try {
    const folder = DriveApp.getFolderById(folderId);
    
    // Get subfolders
    const subfolderMap = {};
    const subfolders = folder.getFolders();
    while (subfolders.hasNext()) {
      const subfolder = subfolders.next();
      const name = subfolder.getName().toLowerCase();
      subfolderMap[name] = subfolder;
    }
    
    for (let i = 0; i < images.length; i++) {
      try {
        Logger.log('Processing image ' + (i + 1));
        const imageData = images[i];
        
        if (!imageData || !imageData.data) {
          Logger.log('Image ' + (i + 1) + ' has no data');
          errors.push('Image ' + (i + 1) + ': No data provided');
          continue;
        }
        
        // Track original size
        if (imageData.originalSize) {
          originalSize += imageData.originalSize;
        }
        
        // Extract base64 data
        let base64Data;
        if (imageData.data.includes(',')) {
          base64Data = imageData.data.split(',')[1];
        } else {
          base64Data = imageData.data;
        }
        
        // Decode base64
        const decoded = Utilities.base64Decode(base64Data);
        
        // Determine file type
        let extension = 'jpg';
        let mimeType = 'image/jpeg';
        
        if (imageData.type) {
          if (imageData.type.includes('png')) {
            extension = 'png';
            mimeType = 'image/png';
          } else if (imageData.type.includes('webp')) {
            extension = 'webp';
            mimeType = 'image/webp';
          } else if (imageData.type.includes('pdf')) {
            extension = 'pdf';
            mimeType = 'application/pdf';
          }
        }
        
        // Create filename
        const category = imageData.category ? '_' + imageData.category : '';
        const filename = referenceNumber + '_' + (i + 1).toString().padStart(2, '0') + category + '.' + extension;
        
        // Create blob
        const blob = Utilities.newBlob(decoded, mimeType, filename);
        
        // Determine target folder
        let targetFolder = folder;
        if (imageData.category) {
          const cat = imageData.category.toLowerCase();
          if (cat === 'exterior' && subfolderMap['exterior_photos']) {
            targetFolder = subfolderMap['exterior_photos'];
          } else if (cat === 'interior' && subfolderMap['interior_photos']) {
            targetFolder = subfolderMap['interior_photos'];
          } else if (cat === 'utility' && subfolderMap['utility_photos']) {
            targetFolder = subfolderMap['utility_photos'];
          } else if (cat === 'damage' && subfolderMap['damage_photos']) {
            targetFolder = subfolderMap['damage_photos'];
          } else if (cat === 'context' && subfolderMap['context_photos']) {
            targetFolder = subfolderMap['context_photos'];
          } else if (cat === 'identification' && subfolderMap['identification']) {
            targetFolder = subfolderMap['identification'];
          } else if (subfolderMap['photos']) {
            targetFolder = subfolderMap['photos'];
          }
        }
        
        // Save to Drive
        const file = targetFolder.createFile(blob);
        
        Logger.log('Image ' + (i + 1) + ' saved: ' + file.getName());
        totalSize += file.getSize();
        savedCount++;
        
      } catch (imageError) {
        Logger.log('Error saving image ' + (i + 1) + ': ' + imageError.toString());
        errors.push('Image ' + (i + 1) + ': ' + imageError.toString());
      }
    }
    
  } catch (error) {
    Logger.log('Error accessing folder: ' + error.toString());
    errors.push('Folder access: ' + error.toString());
  }
  
  const compressionSaved = originalSize > totalSize ? originalSize - totalSize : 0;
  
  Logger.log('Saved ' + savedCount + ' of ' + images.length + ' images');
  
  return {
    savedCount: savedCount,
    totalCount: images.length,
    errors: errors,
    totalSize: totalSize,
    compressionSaved: compressionSaved
  };
}

// Save to spreadsheet
function saveToSheet(data, referenceNumber, folderUrl, processResult) {
  const spreadsheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  let sheet = spreadsheet.getSheetByName('Submissions');
  
  // Create sheet if it doesn't exist
  if (!sheet) {
    sheet = spreadsheet.insertSheet('Submissions');
    const headers = [
      'Timestamp',
      'Reference',
      'Photo Category',
      'Customer Name',
      'Email',
      'Phone',
      'Address',
      'City',
      'State',
      'ZIP',
      'Current Carrier',
      'Vehicle Info',
      'Images Count',
      'Folder URL',
      'Notes',
      'Status',
      'File Size',
      'Compression Saved'
    ];
    sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold');
    sheet.setFrozenRows(1);
  }
  
  const row = [
    new Date().toLocaleString('en-US', {timeZone: 'America/New_York'}),
    referenceNumber,
    data.photoCategory || '',
    data.customerName || '',
    data.email || '',
    data.phone || '',
    data.address || '',
    data.city || '',
    data.state || 'NC',
    data.zip || '',
    data.currentCarrier || '',
    data.vehicleInfo || '',
    processResult.savedCount + '/' + processResult.totalCount,
    folderUrl,
    data.notes || '',
    'New',
    formatFileSize(processResult.totalSize),
    formatFileSize(processResult.compressionSaved)
  ];
  
  sheet.appendRow(row);
}

// Send notifications
function sendNotifications(data, referenceNumber, folderUrl, processResult) {
  // Send to agency
  const agencySubject = 'New ' + (data.photoCategory || 'Photo') + ' Upload - ' + data.customerName + ' - Ref: ' + referenceNumber;
  const agencyBody = formatAgencyEmail(data, referenceNumber, folderUrl, processResult);
  
  MailApp.sendEmail({
    to: CONFIG.EMAIL_TO,
    cc: CONFIG.EMAIL_CC,
    subject: agencySubject,
    htmlBody: agencyBody
  });
  
  // Send to customer
  if (data.email) {
    const customerSubject = 'Photos Received - ' + CONFIG.AGENCY_NAME + ' - Ref: ' + referenceNumber;
    const customerBody = formatCustomerEmail(data, referenceNumber, processResult);
    
    MailApp.sendEmail({
      to: data.email,
      subject: customerSubject,
      htmlBody: customerBody,
      replyTo: CONFIG.AGENCY_EMAIL,
      name: CONFIG.AGENCY_NAME
    });
  }
  
  Logger.log('Notifications sent');
}

// Format agency email
function formatAgencyEmail(data, referenceNumber, folderUrl, processResult) {
  const categoryLabels = {
    'home': 'Home Insurance',
    'claims': 'Claims/Damage',
    'documents': 'Documents',
    'other': 'General'
  };
  
  const statusColor = processResult.savedCount === processResult.totalCount ? '#28a745' : '#ffc107';
  const statusText = processResult.savedCount === processResult.totalCount ? 
    'All Files Uploaded Successfully' : 
    processResult.savedCount + ' of ' + processResult.totalCount + ' Files Uploaded';
  
  return '<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1.0"></head>' +
    '<body style="margin:0;padding:0;font-family:Arial,sans-serif;background:#f4f4f4;">' +
    '<table role="presentation" cellpadding="0" cellspacing="0" style="width:100%;background:#f4f4f4;">' +
    '<tr><td align="center" style="padding:20px 0;">' +
    '<table role="presentation" cellpadding="0" cellspacing="0" style="width:600px;max-width:100%;background:#ffffff;border-radius:10px;">' +
    '<tr><td style="background:linear-gradient(135deg,#1a5f7a 0%,#457b9d 100%);padding:30px;text-align:center;border-radius:10px 10px 0 0;">' +
    '<img src="' + CONFIG.LOGO_URL + '" alt="Bill Layne Insurance" style="max-width:150px;margin-bottom:15px;">' +
    '<h1 style="color:#ffffff;margin:0;font-size:24px;">New ' + (categoryLabels[data.photoCategory] || 'Photo') + ' Upload</h1>' +
    '<p style="color:#ffffff;margin:10px 0 0 0;">Reference: ' + referenceNumber + '</p>' +
    '</td></tr>' +
    '<tr><td style="background:' + statusColor + ';padding:15px;text-align:center;color:#ffffff;font-weight:bold;">' +
    statusText + '</td></tr>' +
    '<tr><td style="padding:30px;">' +
    '<div style="background:#f8f9fa;border-left:4px solid #1a5f7a;padding:15px;margin-bottom:20px;">' +
    '<h3 style="color:#1a5f7a;margin:0 0 15px 0;">Customer Information</h3>' +
    '<p style="margin:5px 0;"><strong>Name:</strong> ' + data.customerName + '</p>' +
    '<p style="margin:5px 0;"><strong>Email:</strong> ' + (data.email || 'Not provided') + '</p>' +
    '<p style="margin:5px 0;"><strong>Phone:</strong> ' + (data.phone || 'Not provided') + '</p>' +
    (data.address ? '<p style="margin:5px 0;"><strong>Address:</strong> ' + data.address + 
      (data.city ? ', ' + data.city : '') + (data.state ? ', ' + data.state : '') + 
      (data.zip ? ' ' + data.zip : '') + '</p>' : '') +
    '</div>' +
    '<div style="background:#e8f4f8;border-left:4px solid #457b9d;padding:15px;margin-bottom:20px;">' +
    '<h3 style="color:#457b9d;margin:0 0 15px 0;">Submission Details</h3>' +
    '<p style="margin:5px 0;"><strong>Category:</strong> ' + (categoryLabels[data.photoCategory] || 'Other') + '</p>' +
    '<p style="margin:5px 0;"><strong>Images:</strong> ' + processResult.savedCount + ' of ' + processResult.totalCount + '</p>' +
    '<p style="margin:5px 0;"><strong>File Size:</strong> ' + formatFileSize(processResult.totalSize) + '</p>' +
    (processResult.compressionSaved > 0 ? '<p style="margin:5px 0;color:#28a745;"><strong>Saved:</strong> ' + formatFileSize(processResult.compressionSaved) + '</p>' : '') +
    '</div>' +
    '<div style="text-align:center;margin:30px 0;">' +
    '<a href="' + folderUrl + '" style="display:inline-block;background:linear-gradient(135deg,#1a5f7a 0%,#457b9d 100%);color:#ffffff;padding:15px 40px;text-decoration:none;border-radius:5px;font-weight:bold;">View Images in Drive</a>' +
    '</div>' +
    '</td></tr>' +
    '<tr><td style="background:#333;padding:20px;text-align:center;border-radius:0 0 10px 10px;">' +
    '<p style="color:#ffffff;margin:0;font-size:12px;">Image Collection System v2.3</p>' +
    '</td></tr>' +
    '</table></td></tr></table></body></html>';
}

// Format customer email
function formatCustomerEmail(data, referenceNumber, processResult) {
  return '<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width, initial-scale=1.0"></head>' +
    '<body style="margin:0;padding:0;font-family:Arial,sans-serif;background:#f4f4f4;">' +
    '<table role="presentation" cellpadding="0" cellspacing="0" style="width:100%;background:#f4f4f4;">' +
    '<tr><td align="center" style="padding:20px 0;">' +
    '<table role="presentation" cellpadding="0" cellspacing="0" style="width:600px;max-width:100%;background:#ffffff;border-radius:10px;">' +
    '<tr><td style="background:linear-gradient(135deg,#1a5f7a 0%,#457b9d 100%);padding:30px;text-align:center;border-radius:10px 10px 0 0;">' +
    '<img src="' + CONFIG.LOGO_URL + '" alt="Bill Layne Insurance" style="max-width:150px;margin-bottom:15px;">' +
    '<h1 style="color:#ffffff;margin:10px 0;font-size:28px;">Photos Received!</h1>' +
    '</td></tr>' +
    '<tr><td style="padding:30px;text-align:center;">' +
    '<div style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#ffffff;padding:20px;border-radius:10px;margin-bottom:20px;">' +
    '<p style="margin:0;font-size:14px;">Your Reference Number</p>' +
    '<p style="margin:10px 0;font-size:24px;font-weight:bold;">' + referenceNumber + '</p>' +
    '<p style="margin:0;font-size:14px;">Please save this for your records</p>' +
    '</div>' +
    '<p style="font-size:16px;color:#333;">Thank you for submitting your photos. We received ' + 
    processResult.savedCount + ' photo' + (processResult.savedCount > 1 ? 's' : '') + ' and will review them promptly.</p>' +
    '<div style="background:#f8f9fa;padding:20px;border-radius:10px;margin:20px 0;">' +
    '<h3 style="color:#1a5f7a;margin:0 0 15px 0;">What Happens Next?</h3>' +
    '<ol style="text-align:left;margin:0;padding-left:20px;color:#666;">' +
    '<li style="margin:5px 0;">We\'ll review your photos within 1-2 business hours</li>' +
    '<li style="margin:5px 0;">Our team will prepare your information</li>' +
    '<li style="margin:5px 0;">You\'ll hear from us via email or phone</li>' +
    '</ol></div>' +
    '<div style="margin:30px 0;">' +
    '<a href="tel:' + CONFIG.AGENCY_PHONE.replace(/\D/g, '') + '" style="display:inline-block;background:#1a5f7a;color:#ffffff;padding:12px 30px;text-decoration:none;border-radius:8px;font-weight:600;">Call ' + CONFIG.AGENCY_PHONE + '</a>' +
    '</div>' +
    '</td></tr>' +
    '<tr><td style="background:#333;padding:20px;text-align:center;border-radius:0 0 10px 10px;">' +
    '<p style="color:#ffffff;margin:5px 0;font-size:14px;">' +
    CONFIG.AGENCY_NAME + '<br>' +
    CONFIG.AGENCY_ADDRESS + '<br>' +
    CONFIG.AGENCY_PHONE + ' | ' + CONFIG.AGENCY_EMAIL + '<br>' +
    '<a href="https://' + CONFIG.AGENCY_WEBSITE + '" style="color:#a8dadc;text-decoration:none;">' + CONFIG.AGENCY_WEBSITE + '</a>' +
    '</p></td></tr>' +
    '</table></td></tr></table></body></html>';
}

// Utility functions
function generateReferenceNumber() {
  const date = new Date();
  const year = date.getFullYear().toString().slice(-2);
  const month = (date.getMonth() + 1).toString().padStart(2, '0');
  const day = date.getDate().toString().padStart(2, '0');
  const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
  return 'BLI-' + year + month + day + '-' + random;
}

function getMonthName(monthIndex) {
  const months = ['January', 'February', 'March', 'April', 'May', 'June',
                  'July', 'August', 'September', 'October', 'November', 'December'];
  return months[monthIndex];
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function logError(error, request) {
  try {
    const spreadsheet = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    let sheet = spreadsheet.getSheetByName('Error Log');
    
    if (!sheet) {
      sheet = spreadsheet.insertSheet('Error Log');
      const headers = ['Timestamp', 'Error Type', 'Error Message', 'Stack Trace', 'Request Data'];
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
      sheet.getRange(1, 1, 1, headers.length).setFontWeight('bold');
      sheet.setFrozenRows(1);
    }
    
    let requestData = 'No data';
    try {
      if (request && request.postData) {
        const data = JSON.parse(request.postData.contents);
        requestData = JSON.stringify({
          customerName: data.customerName,
          email: data.email,
          photoCategory: data.photoCategory,
          imageCount: data.images ? data.images.length : 0
        });
      }
    } catch (e) {
      requestData = 'Error parsing request';
    }
    
    sheet.appendRow([
      new Date().toLocaleString('en-US', {timeZone: 'America/New_York'}),
      error.name || 'Unknown Error',
      error.message || error.toString(),
      error.stack || 'No stack trace',
      requestData
    ]);
    
  } catch (logError) {
    Logger.log('Failed to log error: ' + logError.toString());
  }
}

function createErrorResponse(message) {
  return ContentService
    .createTextOutput(JSON.stringify({
      status: 'error',
      message: message
    }))
    .setMimeType(ContentService.MimeType.JSON)
    .setHeaders({
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'POST',
      'Access-Control-Allow-Headers': 'Content-Type'
    });
}

function doGet() {
  return ContentService
    .createTextOutput('Image Collection System v2.3 Active - ' + new Date().toISOString())
    .setMimeType(ContentService.MimeType.TEXT);
}
